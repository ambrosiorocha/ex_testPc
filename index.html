<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <base target="_top">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Poppins', sans-serif;
            background-color: #f0f2f5;
            color: #333;
            padding: 20px;
        }
        .container {
            max-width: 900px;
            margin: 0 auto 30px auto; /* Adiciona margem inferior */
            background-color: #fff;
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }
        h2 {
            text-align: center;
            color: #2c3e50;
            margin-bottom: 20px;
        }
        .form-group {
            margin-bottom: 15px;
        }
        .form-group label {
            display: block;
            font-size: 14px;
            color: #555;
            margin-bottom: 5px;
        }
        .form-group input, .form-group select {
            width: 100%;
            padding: 10px;
            border-radius: 8px;
            border: 1px solid #ccc;
            box-sizing: border-box;
            font-size: 14px;
        }
        /* Grelha para formulários */
        .form-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }
        .grid-col-span-2 {
            grid-column: span 2;
        }
        .btn {
            width: 100%;
            padding: 12px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            background-color: #27ae60; /* Verde */
            color: #fff;
            transition: background-color 0.3s;
        }
        .btn:hover {
            background-color: #219d54;
        }
        /* Botão azul para Vendas */
        .btn-venda {
            background-color: #3498db; /* Azul */
        }
        .btn-venda:hover {
            background-color: #2980b9;
        }
        
        /* Mensagem de Status */
        #statusMessage, #statusMessageVenda {
            text-align: center;
            margin-top: 15px;
            padding: 10px;
            border-radius: 8px;
            font-size: 14px;
            display: none;
        }
        #statusMessage.success, #statusMessageVenda.success {
            background-color: #e8f5e9;
            color: #2e7d32;
            border: 1px solid #c8e6c9;
        }
        #statusMessage.error, #statusMessageVenda.error {
            background-color: #ffebee;
            color: #c62828;
            border: 1px solid #ef9a9a;
        }
        
        /* Tabela */
        .table-container {
            margin-top: 30px;
            overflow-x: auto;
        }
        .table-container table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 10px;
        }
        .table-container th, .table-container td {
            padding: 12px;
            border: 1px solid #ddd;
            text-align: left;
            font-size: 14px;
        }
        .table-container th {
            background-color: #f2f2f2;
        }
        .action-buttons {
            display: flex;
            gap: 5px;
        }
        .action-buttons button {
            padding: 6px 10px;
            font-size: 12px;
            cursor: pointer;
            border: none;
            border-radius: 4px;
        }
        .edit-btn {
            background-color: #3498db;
            color: #fff;
        }
        .delete-btn {
            background-color: #e74c3c;
            color: #fff;
        }
    </style>
</head>
<body>

    <div class="container">
        <h2>Lançar Nova Venda</h2>
        <form id="vendaForm">
            <div class="form-grid">
                <div class="form-group grid-col-span-2">
                    <label for="vendaProduto">Produto</label>
                    <select id="vendaProduto" required>
                        <option value="">Carregando produtos...</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="vendaQuantidade">Quantidade Vendida</label>
                    <input type="number" id="vendaQuantidade" step="any" min="0" required>
                </div>
                <div class="form-group">
                    <label for="vendaPrecoTotal">Preço Total (R$)</label>
                    <input type="number" id="vendaPrecoTotal" step="0.01" min="0" required>
                </div>
            </div>
            <button type="submit" class="btn btn-venda">Lançar Venda</button>
        </form>
        <div id="statusMessageVenda"></div>
    </div>


    <div class="container">
        <h2>Cadastrar Produto</h2>
        <form id="produtoForm">
            <input type="hidden" id="idProduto" value="">
            <div class="form-group">
                <label for="nome">Nome do Produto</label>
                <input type="text" id="nome" required>
            </div>
            <div class="form-group">
                <label for="unidadeVenda">Unidade de Venda</label>
                <input type="text" id="unidadeVenda" required>
            </div>
            <div class="form-group">
                <label for="preco">Preço (R$)</label>
                <input type="number" id="preco" step="0.01" min="0" required>
            </div>
            <div class="form-group">
                <label for="quantidade">Quantidade em Estoque</label>
                <input type="number" id="quantidade" step="any" min="0" required>
            </div>
            <div class="form-group">
                <label for="descricao">Descrição</label>
                <input type="text" id="descricao">
            </div>
            <button type="submit" class="btn">Cadastrar Produto</button>
        </form>
        <div id="statusMessage"></div>

        <div class="table-container">
            <h3>Produtos Cadastrados</h3>
            <table>
                <thead>
                    <tr>
                        <th>ID do Produto</th>
                        <th>Nome</th>
                        <th>Unidade de Venda</th>
                        <th>Preço</th>
                        <th>Quantidade</th>
                        <th>Descrição</th>
                        <th>Ações</th>
                    </tr>
                </thead>
                <tbody id="listaProdutos">
                    <tr><td colspan="7" style="text-align:center;">Carregando produtos...</td></tr>
                </tbody>
            </table>
        </div>
    </div>

    <script>
        // !! IMPORTANTE !!
        // COLOQUE AQUI A SUA URL DO APPS SCRIPT QUE FUNCIONA NO SEU PC
        // (Pode ser a nova que você criou ou a antiga)
        const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbxk0fSauvjEwhlq_DDRb21wHtH5qcFAs6j3XfJrHQlbW_d8qshOiEuX8lJfKQpHhZet/exec';

        // --- Event Listeners (Gatilhos da Página) ---
        
        document.addEventListener('DOMContentLoaded', function() {
            if(SCRIPT_URL === '') {
                exibirStatus('error', 'Por favor, cole a URL do Apps Script no código.', 'statusMessage');
                return;
            }
            
            // Gatilhos de PRODUTOS
            document.getElementById('produtoForm').addEventListener('submit', salvarProduto);
            carregarProdutos(); // Carrega a tabela de produtos
            
            // NOVOS Gatilhos de VENDAS
            document.getElementById('vendaForm').addEventListener('submit', submeterVenda);
            carregarDropdownProdutos(); // Carrega o dropdown de vendas
        });

        
        // --- Funções de Status (Exibir Mensagens) ---

        function exibirStatus(tipo, mensagem, elementoId) {
            var statusMessage = document.getElementById(elementoId);
            statusMessage.textContent = mensagem;
            statusMessage.className = tipo; // 'success' ou 'error'
            statusMessage.style.display = 'block';
            
            setTimeout(function() {
                statusMessage.style.display = 'none';
            }, 5000);
        }

        
        // =============================================
        // === NOVAS FUNÇÕES DE VENDA ===
        // =============================================

        /**
         * Carrega a lista de produtos da aba "Produtos" e insere no dropdown de Vendas.
         * Usa a ação 'obterProdutos' (a mesma da tabela, é eficiente).
         */
        async function carregarDropdownProdutos() {
            const dropdown = document.getElementById('vendaProduto');
            dropdown.innerHTML = '<option value="">Carregando...</option>';

            try {
                const response = await fetch(SCRIPT_URL, {
                    method: 'POST',
                    body: JSON.stringify({ action: 'obterProdutos' }) // Reutiliza a função de obter produtos
                });
                const data = await response.json();

                if (data.status === 'sucesso' && data.dados.length > 0) {
                    dropdown.innerHTML = '<option value="">Selecione um produto</option>';
                    data.dados.forEach(produto => {
                        // Adiciona o nome e o preço no próprio <option>
                        const option = document.createElement('option');
                        option.value = produto.Nome; // O valor será o nome do produto
                        option.textContent = `${produto.Nome} (R$ ${produto.Preço.toFixed(2)})`;
                        option.dataset.preco = produto.Preço; // Guarda o preço aqui
                        dropdown.appendChild(option);
                    });
                } else {
                    dropdown.innerHTML = '<option value="">Nenhum produto encontrado</option>';
                }
            } catch (error) {
                dropdown.innerHTML = '<option value="">Erro ao carregar</option>';
            }
        }

        /**
         * Chamada quando o formulário de Venda é submetido.
         */
        async function submeterVenda(event) {
            event.preventDefault(); // Impede o recarregamento da página

            const venda = {
                data: new Date().toLocaleDateString("pt-BR"), // Data de hoje
                itens: document.getElementById('vendaProduto').value,
                quantidadeVendida: parseFloat(document.getElementById('vendaQuantidade').value),
                subtotal: parseFloat(document.getElementById('vendaPrecoTotal').value),
                descontoPercentual: 0, // Simplificado (pode adicionar depois)
                descontoReal: 0,       // Simplificado (pode adicionar depois)
                totalComDesconto: parseFloat(document.getElementById('vendaPrecoTotal').value),
                usuario: "Usuário Local" // Simplificado
            };

            // Validação simples
            if (!venda.itens || venda.quantidadeVendida <= 0 || venda.subtotal <= 0) {
                exibirStatus('error', 'Por favor, preencha todos os campos da venda.', 'statusMessageVenda');
                return;
            }

            try {
                const response = await fetch(SCRIPT_URL, {
                    method: 'POST',
                    body: JSON.stringify({ action: 'lancarVenda', data: venda })
                });
                const data = await response.json();
                
                exibirStatus(data.status, data.mensagem, 'statusMessageVenda');
                
                if (data.status === 'sucesso') {
                    document.getElementById('vendaForm').reset();
                }

            } catch (error) {
                exibirStatus('error', 'Erro de comunicação: ' + error.message, 'statusMessageVenda');
            }
        }


        // =============================================
        // === SUAS FUNÇÕES DE PRODUTO (Sem alteração) ===
        // =============================================

        async function salvarProduto(event) {
            event.preventDefault();
            
            const produto = {
                idProduto: document.getElementById('idProduto').value || null,
                nome: document.getElementById('nome').value,
                unidadeVenda: document.getElementById('unidadeVenda').value,
                preco: parseFloat(document.getElementById('preco').value),
                quantidade: parseFloat(document.getElementById('quantidade').value),
                descricao: document.getElementById('descricao').value
            };

            try {
                const response = await fetch(SCRIPT_URL, {
                    method: 'POST',
                    body: JSON.stringify({ action: 'salvarProduto', data: produto })
                });

                const data = await response.json();
                exibirStatus(data.status, data.mensagem, 'statusMessage');
                
                if (data.status === 'sucesso') {
                    document.getElementById('produtoForm').reset();
                    document.getElementById('idProduto').value = '';
                    await carregarProdutos(); // Recarrega a tabela
                    await carregarDropdownProdutos(); // NOVO: Recarrega o dropdown de vendas
                }

            } catch (error) {
                exibirStatus('error', 'Erro de comunicação: ' + error.message, 'statusMessage');
            }
        }
        
        async function carregarProdutos() {
            const listaProdutos = document.getElementById('listaProdutos');
            listaProdutos.innerHTML = '<tr><td colspan="7" style="text-align:center;">Carregando produtos...</td></tr>';

            try {
                const response = await fetch(SCRIPT_URL, {
                    method: 'POST',
                    body: JSON.stringify({ action: 'obterProdutos' })
                });
                const data = await response.json();

                if (data.status === 'sucesso' && data.dados.length > 0) {
                    listaProdutos.innerHTML = '';
                    data.dados.forEach(produto => {
                        const row = document.createElement('tr');
                        row.innerHTML = `
                            <td>${produto['ID do Produto']}</td>
                            <td>${produto.Nome}</td>
                            <td>${produto['Unidade de Venda']}</td>
                            <td>R$ ${produto.Preço.toFixed(2).replace('.', ',')}</td>
                            <td>${produto.Quantidade}</td>
                            <td>${produto.Descrição || ''}</td>
                            <td>
                                <div class="action-buttons">
                                    <button class="edit-btn" onclick="editarProduto(${produto['ID do Produto']})">Editar</button>
                                    <button class="delete-btn" onclick="excluirProduto(${produto['ID do Produto']})">Excluir</button>
                                </div>
                            </td>
                        `;
                        listaProdutos.appendChild(row);
                    });
                } else {
                    listaProdutos.innerHTML = '<tr><td colspan="7" style="text-align:center;">Nenhum produto cadastrado.</td></tr>';
                }
            } catch (error) {
                exibirStatus('error', 'Erro ao carregar lista de produtos: ' + error.message, 'statusMessage');
                listaProdutos.innerHTML = '<tr><td colspan="7" style="text-align:center;">Erro ao carregar produtos.</td></tr>';
            }
        }

        async function editarProduto(id) {
            try {
                const response = await fetch(SCRIPT_URL, {
                    method: 'POST',
                    body: JSON.stringify({ action: 'obterProdutoPorId', data: { id: id } })
                });
                const data = await response.json();
                
                if (data.status === 'sucesso' && data.dados) {
                    const produto = data.dados;
                    document.getElementById('idProduto').value = produto['ID do Produto'];
                    document.getElementById('nome').value = produto.Nome;
                    document.getElementById('unidadeVenda').value = produto['Unidade de Venda'];
                    document.getElementById('preco').value = produto.Preço;
                    document.getElementById('quantidade').value = produto.Quantidade;
                    document.getElementById('descricao').value = produto.Descrição || '';
                    exibirStatus('success', 'Campos preenchidos. Agora você pode editar.', 'statusMessage');
                    window.scrollTo(0, 0); // Rola para o topo para editar
                } else {
                    exibirStatus('error', 'Produto não encontrado para edição.', 'statusMessage');
                }
            } catch (error) {
                exibirStatus('error', 'Erro ao obter dados do produto: ' + error.message, 'statusMessage');
            }
        }

        async function excluirProduto(id) {
            if (confirm(`Tem certeza que deseja excluir o produto com ID ${id}?`)) {
                try {
                    const response = await fetch(SCRIPT_URL, {
                        method: 'POST',
                        body: JSON.stringify({ action: 'excluirProduto', data: { id: id } })
                    });
                    const data = await response.json();
                    exibirStatus(data.status, data.mensagem, 'statusMessage');
                    if (data.status === 'sucesso') {
                        await carregarProdutos(); // Recarrega a tabela
                        await carregarDropdownProdutos(); // NOVO: Recarrega o dropdown de vendas
                    }
                } catch (error) {
                    exibirStatus('error', 'Erro ao excluir o produto: ' + error.message, 'statusMessage');
                }
            }
        }
    </script>
</body>
</html>
